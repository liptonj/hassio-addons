# Persistent Storage Analysis

## Current State

### ✅ Persistent Storage (`/config` - mapped to `config:rw`)

These paths are **persistent** and survive container restarts:

1. **Clients Configuration**
   - Path: `/config/clients/clients.conf`
   - Generated by: `ConfigGenerator.generate_clients_conf()`
   - Status: ✅ Persistent

2. **Certificates**
   - Path: `/config/certs/*`
   - Used by: EAP module, RadSec
   - Status: ✅ Persistent

3. **SQLite Database** (if used)
   - Path: `/config/freeradius.db`
   - Status: ✅ Persistent

### ❌ Non-Persistent Storage (`/etc/raddb` - inside container)

These paths are **NOT persistent** and will be lost on container restart:

1. **Users File**
   - Path: `/etc/raddb/users`
   - Generated by: `ConfigGenerator.generate_users_file()`
   - Status: ❌ **NOT PERSISTENT** - Will be regenerated from database

2. **EAP Module Config**
   - Path: `/etc/raddb/mods-available/eap`
   - Generated by: `EapConfigGenerator.write_config_files()`
   - Status: ❌ **NOT PERSISTENT** - Will be regenerated from database

3. **SQL Module Config**
   - Path: `/etc/raddb/mods-available/sql`
   - Generated by: `SqlConfigGenerator.write_sql_module_config()`
   - Status: ❌ **NOT PERSISTENT** - Will be regenerated from database

4. **SQL Counter Module Config**
   - Path: `/etc/raddb/mods-available/sqlcounter`
   - Generated by: `SqlCounterGenerator.write_sql_counter_config()`
   - Status: ❌ **NOT PERSISTENT** - Will be regenerated from database

5. **Module Symlinks**
   - Path: `/etc/raddb/mods-enabled/*`
   - Status: ❌ **NOT PERSISTENT** - Will be recreated on startup

6. **Policy Files**
   - Path: `/etc/raddb/policy.d/*`
   - Generated by: `PolicyGenerator.generate_policy_file()`
   - Status: ❌ **NOT PERSISTENT** - Will be regenerated from database

7. **Virtual Server Configs**
   - Path: `/etc/raddb/sites-available/*`
   - Generated by: `VirtualServerGenerator`
   - Status: ❌ **NOT PERSISTENT** - Will be regenerated from database

8. **PSK Users File**
   - Path: `/etc/raddb/users-psk` (or similar)
   - Generated by: `PskConfigGenerator.generate_psk_users_file()`
   - Status: ❌ **NOT PERSISTENT** - Will be regenerated from database

9. **MAC Bypass File**
   - Path: `/etc/raddb/users-mac-bypass` (or similar)
   - Generated by: `PskConfigGenerator.generate_mac_bypass_file()`
   - Status: ❌ **NOT PERSISTENT** - Will be regenerated from database

## Impact

### ✅ Good News

1. **Database-Driven**: All configuration is stored in the database, so configs can be regenerated
2. **Auto-Regeneration**: `DatabaseWatcher` automatically regenerates configs on startup
3. **No Data Loss**: Since configs come from database, no actual data is lost

### ⚠️ Concerns

1. **Startup Time**: Config regeneration on every container restart adds startup delay
2. **Race Condition**: If FreeRADIUS starts before configs are regenerated, it may fail
3. **Inconsistency**: Some configs in `/config` (persistent) vs `/etc/raddb` (ephemeral)

## Recommendations

### Option 1: Move All Configs to `/config` (Recommended)

Move all generated configs to `/config/raddb/`:

```python
# In config.py Settings:
radius_config_path: str = "/config/raddb"  # Changed from /etc/raddb
```

**Pros:**
- All configs persistent
- Faster startup (no regeneration needed)
- Consistent with `/config/clients` pattern

**Cons:**
- Need to update FreeRADIUS to use `/config/raddb` instead of `/etc/raddb`
- May require updating `radiusd.conf` paths

### Option 2: Keep Current Approach (Acceptable)

Keep configs in `/etc/raddb` but ensure regeneration on startup:

**Pros:**
- Uses standard FreeRADIUS paths
- No changes needed to FreeRADIUS config

**Cons:**
- Configs regenerated on every restart
- Slight startup delay

### Option 3: Hybrid Approach

- **Persistent**: `/config/raddb/` for user-editable configs
- **Ephemeral**: `/etc/raddb/` for auto-generated configs

**Pros:**
- Best of both worlds
- User can override generated configs if needed

**Cons:**
- More complex
- Need to handle conflicts

## Current Implementation

The current implementation uses **Option 2** (regenerate on startup):

1. **DatabaseWatcher** monitors database changes
2. **Config Generators** regenerate configs from database
3. **Startup Script** (`run.sh`) ensures directories exist
4. **API** triggers regeneration when needed

This works because:
- All configs are database-driven
- `DatabaseWatcher` regenerates on startup
- No manual edits are expected (everything via API)

## Verification

To verify persistence:

```bash
# Check what's in persistent storage
ls -la /config/

# Check what's regenerated
ls -la /etc/raddb/

# Restart container and verify configs are regenerated
docker restart freeradius-server
```

## Conclusion

**Current Status**: ⚠️ **Partially Persistent**

- **Persistent**: `/config/clients`, `/config/certs`, `/config/freeradius.db`
- **Regenerated**: `/etc/raddb/*` (from database on startup)

**Recommendation**: Current approach is acceptable since:
1. All configs are database-driven
2. Auto-regeneration works reliably
3. No data loss occurs

However, for better performance, consider **Option 1** (move to `/config/raddb`).
